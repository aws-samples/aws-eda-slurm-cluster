<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Containers - EDA SLURM Cluster on AWS</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="..">EDA SLURM Cluster on AWS</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href=".." class="nav-link">AWS EDA Slurm Cluster</a>
                            </li>
                            <li class="nav-item">
                                <a href="../deployment-prerequisites/" class="nav-link">Deployment Prerequisites</a>
                            </li>
                            <li class="nav-item">
                                <a href="../security-groups/" class="nav-link">Security Groups</a>
                            </li>
                            <li class="nav-item">
                                <a href="../deploy-parallel-cluster/" class="nav-link">Deploy AWS ParallelCluster</a>
                            </li>
                            <li class="nav-item">
                                <a href="../config/" class="nav-link">Configuraton File Format</a>
                            </li>
                            <li class="nav-item">
                                <a href="../res_integration/" class="nav-link">RES Integration</a>
                            </li>
                            <li class="nav-item">
                                <a href="../soca_integration/" class="nav-link">SOCA Integration</a>
                            </li>
                            <li class="nav-item">
                                <a href="../exostellar-workload-optimizer/" class="nav-link">Exostellar Workload Optimizer (XWO)</a>
                            </li>
                            <li class="nav-item">
                                <a href="../exostellar-infrastructure-optimizer/" class="nav-link">Exostellar Infrastructure Optimizer (XIO)</a>
                            </li>
                            <li class="nav-item">
                                <a href="../custom-amis/" class="nav-link">Custom AMIs for ParallelCluster</a>
                            </li>
                            <li class="nav-item">
                                <a href="../run_jobs/" class="nav-link">Run Jobs</a>
                            </li>
                            <li class="nav-item">
                                <a href="../job_preemption/" class="nav-link">Job Preemption</a>
                            </li>
                            <li class="nav-item">
                                <a href="../rest_api/" class="nav-link">Slurm REST API</a>
                            </li>
                            <li class="nav-item">
                                <a href="../onprem/" class="nav-link">On-Premises Integration</a>
                            </li>
                            <li class="nav-item">
                                <a href="./" class="nav-link active" aria-current="page">Containers</a>
                            </li>
                            <li class="nav-item">
                                <a href="../delete-cluster/" class="nav-link">Delete Cluster</a>
                            </li>
                            <li class="nav-item">
                                <a href="../debug/" class="nav-link">Debug</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../onprem/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../delete-cluster/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/aws-samples/aws-eda-slurm-cluster/edit/master/docs/containers.md" class="nav-link"><i class="fa-brands fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#containers" class="nav-link">Containers</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#using-pyxis" class="nav-link">Using Pyxis</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="3"><a href="#running-a-containerized-job-using-pyxis" class="nav-link">Running a containerized job using Pyxis</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#using-oci-containers" class="nav-link">Using OCI containers</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="3"><a href="#configure-rootless-docker-on-login-and-compute-nodes" class="nav-link">Configure rootless docker on login and compute nodes</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="3"><a href="#per-user-configuration" class="nav-link">Per user configuration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="3"><a href="#create-oci-bundle" class="nav-link">Create OCI Bundle</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="3"><a href="#run-a-bundle-on-slurm-using-oci-container" class="nav-link">Run a bundle on Slurm using OCI container</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="containers">Containers</h1>
<p>Slurm supports running jobs in unprivileged containers a couple of different ways.
It natively supports running jobs in unprivileged <a href="https://slurm.schedmd.com/containers.html">Open Container Initiative (OCI) containers</a>.
Starting with ParallelCluster 3.11.1, it also supports running docker containers using the <a href="https://github.com/NVIDIA/pyxis">Pyxis SPANK plugin</a> which uses <a href="https://github.com/NVIDIA/enroot">enroot</a> to run unprivileged containers.
I will describe using Pyxis first because it is easier than using OCI containers.</p>
<p><strong>Note</strong>: Most EDA tools are not containerized.
Some won't run in containers and some may run in a container, but not correctly.
I recommend following the guidance of your EDA vendor and consult with them.</p>
<p>I've seen a couple of main motivations for using containers for EDA tools.
The first is because orchestration tools like Kubernetes and AWS Batch require jobs to run in containers.
The other is to have more flexibility managing the run time environment of the tools.
Since the EDA tools themselves aren't containerized, the container is usually used to manage file system mounts and packages that are used by the tools.
If new packages are required by a new tool, then it is easy to update and distribute a new version of the container.
Another reason is to use legacy OS distributions on an instance running a newer distribution.</p>
<h2 id="using-pyxis">Using Pyxis</h2>
<p>The enroot and Pyxis packages were developed by NVIDIA to make it easier to run containers on Slurm compute nodes.
ParallelCluster started installing enroot and Pyxis in version 3.11.1 so that you can <a href="https://docs.aws.amazon.com/en_us/parallelcluster/latest/ug/tutorials_11_running-containerized-jobs-with-pyxis.html">run containerized jobs with Pyxis</a>.</p>
<p>To configure Slurm to use the Pyxis plugin, set the <strong>slurm/ParallelClusterConfig/EnablePyxis</strong> parameter to <strong>true</strong> and create or update your cluster.
This will configure the head node to use the Pyxis plugin.
It will also configure your external login nodes to install, configure, and use enroot and the Pyxis plugin.</p>
<h3 id="running-a-containerized-job-using-pyxis">Running a containerized job using Pyxis</h3>
<p>With Pyxis configured in your cluster, you have new options in srun and sbatch to specify a container image.</p>
<pre><code># Submitting an interactive job
srun -N 2 --container-image docker://rockylinux:8 hostname

# Submitting a batch job
sbatch -N 2 --wrap='srun --container-image docker://rockylinux:8 hostname'
</code></pre>
<h2 id="using-oci-containers">Using OCI containers</h2>
<p>Slurm supports <a href="https://slurm.schedmd.com/containers.html">running jobs in unprivileged OCI containers</a>.
OCI is the <a href="https://opencontainers.org/">Open Container Initiative</a>, an open governance structure with the purpose of creating open industry standards around container formats and runtimes.</p>
<p>I'm going to document how to add OCI support to your EDA Slurm cluster.</p>
<p><strong>NOTE</strong>: Rootless docker requires user-specific setup for each user that will run the containers.
For this reason, it is much easier to use Pyxis.</p>
<h3 id="configure-rootless-docker-on-login-and-compute-nodes">Configure rootless docker on login and compute nodes</h3>
<p>The login and compute nodes must be configured to use an unprivileged container runtime.</p>
<p>Run the following script as root to install rootless Docker.</p>
<pre><code>/opt/slurm/${ClusterName}/config/bin/install-rootless-docker.sh
</code></pre>
<p>The script <a href="https://docs.docker.com/engine/install/rhel/">installs the latest Docker from the Docker yum repo</a>.</p>
<p>The creation of a compute node AMI with rootless docker installed has been automated in the <a href="../custom-amis/">creation of a custom compute node AMI</a>.
Use one of the build config files with <strong>docker</strong> in the name to create a custom AMI and configure your cluster to use it.</p>
<h3 id="per-user-configuration">Per user configuration</h3>
<p>Next, <a href="https://docs.docker.com/engine/security/rootless/">configure Docker to run rootless</a> by running the following script as the user that will be running Docker.</p>
<pre><code>dockerd-rootless-setuptool.sh
</code></pre>
<p>Each user that will run Docker must have an entry in <code>/etc/subuid</code> and <code>/etc/subgid</code>.
The creates_users_groups_json.py script will create <code>/opt/slurm/config/subuid</code> and <code>/opt/slurm/config/subgid</code> and the compute nodes will copy them to <code>/etc/subuid</code> and <code>/etc/subgid</code>.</p>
<p>You must configure docker to use a non-NFS storage location for storing images.</p>
<p><code>~/.config/docker/daemon.json</code>:</p>
<pre><code>{
    &quot;data-root&quot;: &quot;/var/tmp/${USER}/containers/storage&quot;
}
</code></pre>
<h3 id="create-oci-bundle">Create OCI Bundle</h3>
<p>Each container requires an <a href="https://slurm.schedmd.com/containers.html#bundle">OCI bundle</a>.</p>
<p>The bundle directories can be stored on NFS and shared between users.
For example, you could create an oci-bundles directory on your shared file system.</p>
<p>This shows how to create an ubuntu bundle.
You can do this as root with the docker service running, but it would be better to run
it using rootless Docker.</p>
<pre><code>export OCI_BUNDLES_DIR=~/oci-bundles
export IMAGE_NAME=ubuntu
export BUNDLE_NAME=ubuntu
mkdir -p $OCI_BUNDLES_DIR
cd $OCI_BUNDLES_DIR
mkdir -p $BUNDLE_NAME
cd $BUNDLE_NAME
docker pull $IMAGE_NAME
docker export $(docker create $IMAGE_NAME) &gt; $BUNDLE_NAME.tar
mkdir rootfs
tar -C rootfs -xf $IMAGE_NAME.tar
runc spec --rootless
runc run containerid1
</code></pre>
<p>The same process works for Rocky Linux 8.</p>
<pre><code>export OCI_BUNDLES_DIR=~/oci-bundles
export IMAGE_NAME=rockylinux:8
export BUNDLE_NAME=rockylinux8
mkdir -p $OCI_BUNDLES_DIR
cd $OCI_BUNDLES_DIR
mkdir -p $BUNDLE_NAME
cd $BUNDLE_NAME
docker pull $IMAGE_NAME
docker export $(docker create $IMAGE_NAME) &gt; $BUNDLE_NAME.tar
mkdir rootfs
tar -C rootfs -xf $BUNDLE_NAME.tar
runc spec --rootless
runc run containerid2
</code></pre>
<h3 id="run-a-bundle-on-slurm-using-oci-container">Run a bundle on Slurm using OCI container</h3>
<pre><code>export OCI_BUNDLES_DIR=~/oci-bundles
export BUNDLE_NAME=rockylinux8

srun -p interactive --container $OCI_BUNDLES_DIR/$BUNDLE_NAME --pty hostname

srun -p interactive --container $OCI_BUNDLES_DIR/$BUNDLE_NAME --pty bash

sbatch -p interactive --container $OCI_BUNDLES_DIR/$BUNDLE_NAME --wrap hostname
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
