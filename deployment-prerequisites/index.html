<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Deployment Prerequisites - EDA SLURM Cluster on AWS</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="..">EDA SLURM Cluster on AWS</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href=".." class="nav-link">AWS EDA Slurm Cluster</a>
                            </li>
                            <li class="nav-item">
                                <a href="./" class="nav-link active" aria-current="page">Deployment Prerequisites</a>
                            </li>
                            <li class="nav-item">
                                <a href="../security-groups/" class="nav-link">Security Groups</a>
                            </li>
                            <li class="nav-item">
                                <a href="../deploy-parallel-cluster/" class="nav-link">Deploy AWS ParallelCluster</a>
                            </li>
                            <li class="nav-item">
                                <a href="../config/" class="nav-link">Configuraton File Format</a>
                            </li>
                            <li class="nav-item">
                                <a href="../res_integration/" class="nav-link">RES Integration</a>
                            </li>
                            <li class="nav-item">
                                <a href="../soca_integration/" class="nav-link">SOCA Integration</a>
                            </li>
                            <li class="nav-item">
                                <a href="../exostellar-workload-optimizer/" class="nav-link">Exostellar Workload Optimizer (XWO)</a>
                            </li>
                            <li class="nav-item">
                                <a href="../exostellar-infrastructure-optimizer/" class="nav-link">Exostellar Infrastructure Optimizer (XIO)</a>
                            </li>
                            <li class="nav-item">
                                <a href="../custom-amis/" class="nav-link">Custom AMIs for ParallelCluster</a>
                            </li>
                            <li class="nav-item">
                                <a href="../run_jobs/" class="nav-link">Run Jobs</a>
                            </li>
                            <li class="nav-item">
                                <a href="../job_preemption/" class="nav-link">Job Preemption</a>
                            </li>
                            <li class="nav-item">
                                <a href="../rest_api/" class="nav-link">Slurm REST API</a>
                            </li>
                            <li class="nav-item">
                                <a href="../onprem/" class="nav-link">On-Premises Integration</a>
                            </li>
                            <li class="nav-item">
                                <a href="../containers/" class="nav-link">Containers</a>
                            </li>
                            <li class="nav-item">
                                <a href="../delete-cluster/" class="nav-link">Delete Cluster</a>
                            </li>
                            <li class="nav-item">
                                <a href="../debug/" class="nav-link">Debug</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href=".." class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../security-groups/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/aws-samples/aws-eda-slurm-cluster/edit/master/docs/deployment-prerequisites.md" class="nav-link"><i class="fa-brands fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#deployment-prerequisites" class="nav-link">Deployment Prerequisites</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#deployment-serverinstance-requirements" class="nav-link">Deployment Server/Instance Requirements</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#configure-aws-cli-credentials" class="nav-link">Configure AWS CLI Credentials</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#clone-or-download-the-repository" class="nav-link">Clone or Download the Repository</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#create-sns-topic-for-error-notifications-optional-but-recommended" class="nav-link">Create SNS Topic for Error Notifications (Optional but recommended)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#make-sure-using-at-least-python-version-37" class="nav-link">Make sure using at least python version 3.7</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#make-sure-required-packages-are-installed" class="nav-link">Make sure required packages are installed</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="3"><a href="#install-cloud-development-kit-cdk-optional" class="nav-link">Install Cloud Development Kit (CDK) (Optional)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#create-parallelcluster-ui-optional-but-recommended" class="nav-link">Create ParallelCluster UI (optional but recommended)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#create-munge-key" class="nav-link">Create Munge Key</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#create-parallelcluster-slurm-database" class="nav-link">Create ParallelCluster Slurm Database</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#create-slurmdbd-instance" class="nav-link">Create Slurmdbd Instance</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#shared-security-groups-for-login-nodes-and-file-systems" class="nav-link">Shared Security Groups for login nodes and file systems</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#create-file-systems" class="nav-link">Create File Systems</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#create-exostellar-management-server" class="nav-link">Create Exostellar Management Server</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#create-configuration-file" class="nav-link">Create Configuration File</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="3"><a href="#configure-slurm-accounting-database-slurmdbd" class="nav-link">Configure Slurm Accounting database (slurmdbd)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="3"><a href="#configure-linux-users-and-groups" class="nav-link">Configure Linux Users and Groups</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="3"><a href="#configure-the-compute-instances" class="nav-link">Configure the Compute Instances</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="3"><a href="#configure-fair-share-scheduling-optional" class="nav-link">Configure Fair Share Scheduling (Optional)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="3"><a href="#configure-licenses" class="nav-link">Configure Licenses</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="3"><a href="#configure-file-systems" class="nav-link">Configure File Systems</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="4"><a href="#lustre" class="nav-link">Lustre</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="4"><a href="#ontap" class="nav-link">ONTAP</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="4"><a href="#zfs" class="nav-link">ZFS</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-bs-level="3"><a href="#configure-custom-partitions-optional" class="nav-link">Configure Custom Partitions (Optional)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="3"><a href="#configure-custom-headcompute-node-scripts" class="nav-link">Configure Custom Head/Compute Node Scripts</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="4"><a href="#head-node-scripts" class="nav-link">Head Node Scripts</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="4"><a href="#compute-node-scripts" class="nav-link">Compute Node Scripts</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="deployment-prerequisites">Deployment Prerequisites</h1>
<p>This page shows common prerequisites that need to be done before deployment.</p>
<h2 id="deployment-serverinstance-requirements">Deployment Server/Instance Requirements</h2>
<p>The deployment process was developed and tested using Mac OS and RHEL 8.
Amazon Linux 2 doesn't support the current version of node.js so it cannot be used.
It has also been tested on RHEL 9 and should work on Rocky Linux 8 and 9.</p>
<p>If the required packages aren't installed then you will need sudo or root access on the instance.</p>
<h2 id="configure-aws-cli-credentials">Configure AWS CLI Credentials</h2>
<p>You will needs AWS credentials that provide admin access to deploy the cluster.</p>
<h2 id="clone-or-download-the-repository">Clone or Download the Repository</h2>
<p>Clone or download the aws-eda-slurm-cluster repository to your system.</p>
<pre><code>git clone https://github.com/aws-samples/aws-eda-slurm-cluster.git
</code></pre>
<h2 id="create-sns-topic-for-error-notifications-optional-but-recommended">Create SNS Topic for Error Notifications (Optional but recommended)</h2>
<p>The Slurm cluster allows you to specify an SNS notification that will be notified when an error is detected.
You can provide the ARN for the topic in the config file or on the command line.</p>
<p>You can use the SNS notification in various ways.
The simplest is to subscribe your email address to the topic so that you get an email when there is an error.
You could also use it to trigger a CloudWatch alarm that could be used to trigger a lambda to do automatic
remediation or create a support ticket.</p>
<h2 id="make-sure-using-at-least-python-version-37">Make sure using at least python version 3.7</h2>
<p>This application requires at least python version 3.7.</p>
<p>Many distributions use older versions of python by default such as python 3.6.8 in RHEL 8 and Rocky Linux 8.
Newer versions are available, but can't be made the system default without breaking OS tools such as yum.
The easiest way to get around this is to create a python virtual environment using a newer version of python.
Simply install the newer version and then use it to create and activate a virtual environment.</p>
<pre><code>$ python3 --version
Python 3.6.8
$ yum -y install python3.12
$ python3.12 -m venv ~/.venv-python3.12
$ source ~/.venv-python3.12/bin/activate
$ python3 --version
Python 3.12.8
</code></pre>
<h2 id="make-sure-required-packages-are-installed">Make sure required packages are installed</h2>
<pre><code>cd aws-eda-slurm-cluster
source setup.sh
</code></pre>
<p>The setup script assumes that you have sudo access so that you can install or update packages.
If you do not, then contact an administrator to help you do the updates.
If necessary modify the setup script for your environment.</p>
<h3 id="install-cloud-development-kit-cdk-optional">Install Cloud Development Kit (CDK) (Optional)</h3>
<p>The setup script will attempt to install all of the prerequisites for you.
If the install script fails on your system then you can refer to this section for instructions
on how to install or update CDK.</p>
<p>This cluster uses Cloud Development Kit (CDK) and Python 3 to deploy the cluster.</p>
<p>Install the packages used by the installer.</p>
<pre><code>sudo yum -y install curl gcc-c++ make nfs-utils python3 tcl unzip wget
</code></pre>
<p>The following link documents how to setup for CDK.
Follow the instructions for Python.</p>
<p><a href="https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html#getting_started_prerequisites">https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html#getting_started_prerequisites</a></p>
<p>Note that CDK requires a pretty new version of nodejs which you may have to download from, for example, <a href="https://nodejs.org/dist/v20.19.0/node-v20.19.0-linux-x64.tar.xz">https://nodejs.org/dist/v20.19.0/node-v20.19.0-linux-x64.tar.xz</a></p>
<pre><code>sudo yum -y install wget
wget https://nodejs.org/dist/v20.19.0/node-v20.19.0-linux-x64.tar.xz
tar -xf node-v20.19.0-linux-x64.tar.xz ~
</code></pre>
<p>Add the nodjs bin directory to your path.</p>
<p><a href="https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html#getting_started_install">https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html#getting_started_install</a></p>
<p>Note that the version of aws-cdk changes frequently.
The version that has been tested is in the CDK_VERSION variable in the install script.</p>
<p>The install script will try to install the prerequisites if they aren't already installed.</p>
<h2 id="create-parallelcluster-ui-optional-but-recommended">Create ParallelCluster UI (optional but recommended)</h2>
<p>It is highly recommended to create a ParallelCluster UI to manage your ParallelCluster clusters.
A different UI is required for each version of ParallelCluster that you are using.
The versions are list in the <a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/document_history.html">ParallelCluster Release Notes</a>.
The minimum required version is 3.6.0 which adds support for RHEL 8 and increases the number of allows queues and compute resources.
The suggested version is at least 3.7.0 because it adds configurable compute node weights which we use to prioritize the selection of
compute nodes by their cost.</p>
<p>The instructions are in the <a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/install-pcui-v3.html">ParallelCluster User Guide</a>.</p>
<h2 id="create-munge-key">Create Munge Key</h2>
<p>Munge is a package that Slurm uses to secure communication between servers.
The munge service uses a preshared key that must be the same on all of the servers in the Slurm cluster.
If you want to be able to use multiple clusters from your submission hosts, such as virtual desktops, then all of the clusters must be using the same munge key.
This is done by creating a munge key and storing it in secrets manager.
The secret is then passed as a parameter to ParallelCluster so that it can use it when configuring munge on all of the cluster instances.</p>
<p>To create the munge key and store it in AWS Secrets Manager, run the following commands.</p>
<pre><code>aws secretsmanager create-secret --name SlurmMungeKey --secret-string &quot;$(dd if=/dev/random bs=1024 count=1 | base64 -w 0)&quot;
</code></pre>
<p>Save the ARN of the secret for when you create the Slurmdbd instance and for when you create the configuration file.</p>
<p>See the <a href="https://slurm.schedmd.com/authentication.html">Slurm documentation for authentication</a> for more information.</p>
<p>See the <a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/Scheduling-v3.html#yaml-Scheduling-SlurmSettings-MungeKeySecretArn">ParallelCluster documentation for MungeKeySecretArn</a>.</p>
<p>See the <a href="../config/#mungekeysecret">MungeKeySecret configuration parameter</a>.</p>
<h2 id="create-parallelcluster-slurm-database">Create ParallelCluster Slurm Database</h2>
<p>The Slurm Database is required for configuring Slurm accounts, users, groups, and fair share scheduling.
It you need these and other features then you will need to create a ParallelCluster Slurm Database.
You do not need to create a new database for each cluster; multiple clusters can share the same database.
Follow the directions in this <a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/tutorials_07_slurm-accounting-v3.html#slurm-accounting-db-stack-v3">ParallelCluster tutorial to configure slurm accounting</a>.</p>
<h2 id="create-slurmdbd-instance">Create Slurmdbd Instance</h2>
<p><strong>Note</strong>: Before ParallelCluster 3.10.0, the slurmdbd daemon that connects to the data was created on each cluster's head node.
The recommended Slurm architecture is to have a shared slurmdbd daemon that is used by all of the clusters.
Starting in version 3.10.0, ParallelCluster supports specifying an external slurmdbd instance when you create a cluster and provide a cloud formation template to create it.</p>
<p><strong>Note</strong>: The Slurm version used by slurmdbd must be greater than or equal to the version of your clusters.
If you have already deployed a slurmdbd instance then you will need to create a new slurmdbd
instance with the latest version of ParallelCluster.
Also note that Slurm only maintains backwards compatibility for the 2 previous major releases so
at some point you will need upgrade your clusters to newer versions before you can use the latest version
of ParallelCluster.</p>
<p>Follow the directions in this <a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/external-slurmdb-accounting.html#external-slurmdb-accounting-step1">ParallelCluster tutorial to configure slurmdbd</a>.
This requires that you have already created the slurm database.</p>
<p>Here are some notes on the required parameters and how to fill them out.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>AmiId</td>
<td>You can get this using the ParallelCluster UI. Click on Images and sort on Operating system. Confirm that the version is at least 3.10.0. Select the AMI for alinux2023 and the arm64 architecture.</td>
</tr>
<tr>
<td>CustomCookbookUrl</td>
<td>Leave blank</td>
</tr>
<tr>
<td>DBMSClientSG</td>
<td>Get this from the DatabaseClientSecurityGroup output of the database stack.</td>
</tr>
<tr>
<td>DBMSDatabaseName</td>
<td>This is an arbitrary name. It must be alphanumeric. I use <strong>slurmaccounting</strong></td>
</tr>
<tr>
<td>DBMSPasswordSecretArn</td>
<td>Get this from the DatabaseSecretArn output of the database stack</td>
</tr>
<tr>
<td>DBMSUri</td>
<td>Get this from the DatabaseHost output of the database stack. Note that if you copy and paste the link you should delete the https:// prefix and the trailing '/'.</td>
</tr>
<tr>
<td>DBMSUsername</td>
<td>Get this from the DatabaseAdminUser output of the database stack.</td>
</tr>
<tr>
<td>EnableSlurmdbdSystemService</td>
<td>Set to true. Note the warning. If the database already exists and was created with an older version of slurm then the database will be upgraded. This may break clusters using an older slurm version that are still using the cluster. Set to false if you don't want this to happen.</td>
</tr>
<tr>
<td>InstanceType</td>
<td>Choose an instance type that is compatible with the AMI. For example, m7g.large.</td>
</tr>
<tr>
<td>KeyName</td>
<td>Use an existing EC2 key pair.</td>
</tr>
<tr>
<td>MungeKeySecretArn</td>
<td>ARN of an existing munge key secret. See <a href="#create-munge-key">Create Munge Key</a>.</td>
</tr>
<tr>
<td>PrivateIp</td>
<td>Choose an available IP in the subnet.</td>
</tr>
<tr>
<td>PrivatePrefix</td>
<td>CIDR of the instance's subnet.</td>
</tr>
<tr>
<td>SlurmdbdPort</td>
<td>6819</td>
</tr>
<tr>
<td>SubnetId</td>
<td>Preferably the same subnet where the clusters will be deployed.</td>
</tr>
<tr>
<td>VPCId</td>
<td>The VPC of the subnet.</td>
</tr>
</tbody>
</table>
<p>The stack name will be used in two places.
It will be used by the script that creates security groups for you in the following section.
It will also be used in the slurm/ParallelClusterConfig/<a href="../config/#slurmdbdstackname">SlurmdbdStackName</a> configuration parameter when you create your cluster.</p>
<p>The stack will only take about 3 minutes to deploy.</p>
<h2 id="shared-security-groups-for-login-nodes-and-file-systems">Shared Security Groups for login nodes and file systems</h2>
<p>Instances like remote desktops that access the cluster directly are called login nodes.
If you want to use your own login nodes to access the cluster, then you must define
several security groups that allow connections between the login nodes, the Slurm head node, and the Slurm compute nodes.
If you are using shared file servers like FSx file systems, then you also need to configure security
groups for the file systems that allows the login and slurm nodes to access the file systems.</p>
<p>The <a href="../security-groups/">details</a> are straightforward, but time consuming, so the process has been automated for you.
Simply run the following script which will deploy a CloudFormation stack that creates the required
security groups.</p>
<pre><code>cd aws-eda-slurm-cluster
./create-slurm-security-groups.sh --region &lt;REGION&gt; --stack-name &lt;STACK_NAME&gt; --VpcId &lt;VPC_ID&gt;
</code></pre>
<p>Additional script options can be specified if you created an external SlurmDbd instance or have existing security groups for your FSx file systems.</p>
<table>
<thead>
<tr>
<th>Script Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>--slurmdbd-stack-name</strong></td>
<td>Stack name that deployed external slurmdbd instance.</td>
</tr>
<tr>
<td><strong>--slurmdbd-security-group-id</strong></td>
<td>Id of security group attached to the slurmdbd instance.</td>
</tr>
<tr>
<td><strong>--fsxl-security-group-id</strong></td>
<td>Id of security group attached to FSx for Lustre file systems</td>
</tr>
<tr>
<td><strong>--fsxo-security-group-id</strong></td>
<td>Id of security group attached to FSx for NetApp Ontap file systems</td>
</tr>
<tr>
<td><strong>--fsxz-security-group-id</strong></td>
<td>Id of security group attached to FSx for OpenZfs file systems</td>
</tr>
</tbody>
</table>
<p>The stack outputs will have the security group ids.</p>
<table>
<thead>
<tr>
<th>Output Name</th>
<th>Use</th>
</tr>
</thead>
<tbody>
<tr>
<td>SlurmHeadNodeSGId</td>
<td>Additional security group for Slurm head node</td>
</tr>
<tr>
<td>SlurmComputeNodeSGId</td>
<td>Additional security group for Slurm compute nodes</td>
</tr>
<tr>
<td>SlurmSubmitterSGId</td>
<td>Additional security group for Slurm login nodes</td>
</tr>
<tr>
<td>SlurmLustreSGId</td>
<td>Security group for FSx for Lustre file systems</td>
</tr>
<tr>
<td>SlurmOntapSGId</td>
<td>Security group for FSx for NetApp Ontap file systems</td>
</tr>
<tr>
<td>SlurmZfsSGId</td>
<td>Security group for FSx for OpenZfs file systems</td>
</tr>
</tbody>
</table>
<p>You can pass the name of the stack to the <a href="../config/#additionalsecuritygroupsstackname">AdditionalSecurityGroupsStackName</a> configuration parameter when you create your cluster
and it will get the security groups ids for you and configure the cluster to use them.</p>
<h2 id="create-file-systems">Create File Systems</h2>
<p>Most EDA workloads require a high performance shared file system.
AWS provides managed file systems that meet the needs of EDA workloads.
FSx for NetApp ONTAP, FSx for OpenZfs, and FSx for Lustre are managed file systems
that meet the needs of EDA workloads.</p>
<p>Create the file systems that you require and use the appropriate security group from the previous section
when you create the file system.</p>
<p>If the file system already exists, then attach the appropriate security group to the network interfaces of
the file systems.</p>
<h2 id="create-exostellar-management-server">Create Exostellar Management Server</h2>
<p>If you're going to use Exostellar Infrastructure Optimizer (XIO) then you will need to deploy the Exostellar management server.
See the <a href="../exostellar-infrastructure-optimizer/">XIO page</a> for details.</p>
<h2 id="create-configuration-file">Create Configuration File</h2>
<p>Before you deploy a cluster you need to create a configuration file.
A default configuration file is found in <a href="https://github.com/aws-samples/aws-eda-slurm-cluster/blob/main/source/resources/config/default_config.yml">source/resources/config/default_config.yml</a>.
You should create a new config file and update the parameters for your cluster.
Ideally you should version control this file so you can keep track of changes.</p>
<p>The schema for the config file along with its default values can be found in <a href="https://github.com/aws-samples/aws-eda-slurm-cluster/blob/main/source/cdk/config_schema.py#L230-L445">source/cdk/config_schema.py</a>.
The schema is defined in python, but the actual config file should be in yaml format.
See <a href="../config/">Configuration File Format</a> for documentation on all of the parameters.</p>
<p>The following are key parameters that you will need to update.
If you do not have the required parameters in your config file then the installer script will fail unless you specify the <code>--prompt</code> option.
You should save your selections in the config file.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
<th>Valid Values</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="../config/#stackname">StackName</a></td>
<td>The cloudformation stack that will deploy the cluster. I prefer to end the name with "-config" .</td>
<td></td>
<td>None</td>
</tr>
<tr>
<td><a href="../config/#clustername">slurm/ClusterName</a></td>
<td>Name of the Slurm cluster</td>
<td>Can't be the same as StackName.</td>
<td>If StackName ends in "-config" then StackName with "-config" stripped off. Otherwise, StackName with "-cl" appended.</td>
</tr>
<tr>
<td><a href="../config/#region">Region</a></td>
<td>Region where VPC is located</td>
<td></td>
<td><code>$AWS_DEFAULT_REGION</code></td>
</tr>
<tr>
<td><a href="../config/#vpcid">VpcId</a></td>
<td>The vpc where the cluster will be deployed.</td>
<td>vpc-*</td>
<td>None</td>
</tr>
<tr>
<td><a href="../config/#sshkeypair">SshKeyPair</a></td>
<td>EC2 Keypair to use for instances</td>
<td></td>
<td>None</td>
</tr>
<tr>
<td><a href="../config/#errorsnstopicarn">ErrorSnsTopicArn</a></td>
<td>ARN of an SNS topic that will be notified of errors</td>
<td><code>arn:aws:sns:{{region}}:{AccountId}:{TopicName}</code></td>
<td>None</td>
</tr>
<tr>
<td><a href="../config/#instanceconfig">slurm/InstanceConfig</a></td>
<td>Configure instance types that the cluster can use and number of nodes.</td>
<td></td>
<td>See <a href="https://github.com/aws-samples/aws-eda-slurm-cluster/blob/main/source/resources/config/default_config.yml">default_config.yml</a></td>
</tr>
<tr>
<td><a href="../config/#additionalsecuritygroupsstackname">AdditionalSecurityGroupsStackName</a></td>
<td>Name of stack that created security groups for external login nodes and file systems.</td>
<td></td>
<td></td>
</tr>
<tr>
<td><a href="../config/##resstackname">RESStackName</a></td>
<td>Name of RES environment</td>
<td></td>
<td></td>
</tr>
<tr>
<td><a href="../config/#extramounts">slurm/storage/ExtraMounts</a></td>
<td>Extra mount points</td>
<td></td>
<td>None</td>
</tr>
</tbody>
</table>
<h3 id="configure-slurm-accounting-database-slurmdbd">Configure Slurm Accounting database (slurmdbd)</h3>
<p>If you <a href="#create-parallelcluster-slurm-database">created a ParallelCluster Slurm Database</a> and a <a href="#create-slurmdbd-instance">Slurmdbd Instance</a> then add the following configuration parameters.</p>
<pre><code>slurm:
  ParallelClusterConfig:
    Slurmdbd:
      SlurmdbdStackName: &lt;Slurmdbd-Stack-Name&gt;
</code></pre>
<h3 id="configure-linux-users-and-groups">Configure Linux Users and Groups</h3>
<p>The cluster defines a script that can capture the users and groups from your identity provider (IDP) into a json file.
When a new compute node starts, another script creates local Linux users and groups from the json file.</p>
<p>The first script gets installed at:</p>
<p><code>/opt/slurm/{{ cluster_name }}/config/bin/create_users_and_groups_json.py</code></p>
<p>This script should be run on an instance that is joined to your IDP.
It first tries to use <code>wbinfo -u</code> and if that fails it uses <code>getent passwd</code> to get the list of users and their userids.
It uses <code>id</code> to get the uid and gids for the users.
The json file gets stored at</p>
<p><code>/opt/slurm/{{ cluster_name }}/config/users_groups.json</code></p>
<p>The compute node calls:</p>
<p><code>/opt/slurm/{{ cluster_name }}/config/bin/create_users_groups.py -i /opt/slurm/{{ cluster_name }}/config/users_groups.json</code></p>
<p>The script calls useradd and groupadd to create local users and groups.</p>
<p>To enable this mechanism you must configure the EC2 tags of the domain joined instance that will be used to create the json file.
A Lambda function will create the json file and create a lambda that will refresh it hourly.
You will also need to provide the security group id of the SlurmExternalLoginNodeSG which will be added to the instance so that it can mount the head node's NFS file system.</p>
<pre><code>DomainJoinedInstance:
  Tags:
    - Key: Name
      Value: ClusterManager
  SecurityGroupId: sg-xxxxxxxx
</code></pre>
<p>You can provide 1 or more keys and the set will be done on the first instance that matches.</p>
<p><strong>Note:</strong> You do not have to use this mechanism.
ParallelCluster supports using Microsoft Active Directory and you can configure that using the <code>slurm/ParallelClusterConfig/ClusterConfig/DirectoryService</code> <a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/DirectoryService-v3.html">parameter</a>.
You can also use custom action scripts that run on your compute nodes that configure domains or users and groups to meet your needs.</p>
<p><strong>Note:</strong> This is automatically configured for you if you specify the <a href="../config/#resstackname">RESStackName</a> parameter.</p>
<h3 id="configure-the-compute-instances">Configure the Compute Instances</h3>
<p>The <a href="../config/#instanceconfig">slurm/InstanceConfig</a> configuration parameter configures the base operating systems, CPU architectures, instance families,
and instance types that the Slurm cluster should support.
ParallelCluster currently doesn't support heterogeneous clusters;
all nodes must have the same architecture and Base OS.</p>
<table>
<thead>
<tr>
<th>Base OS</th>
<th>CPU Architectures</th>
</tr>
</thead>
<tbody>
<tr>
<td>Amazon Linux 2</td>
<td>x86_64, arm64</td>
</tr>
<tr>
<td>CentOS 7</td>
<td>x86_64</td>
</tr>
<tr>
<td>RedHat 7</td>
<td>x86_64</td>
</tr>
<tr>
<td>RedHat 8</td>
<td>x86_64, arm64</td>
</tr>
<tr>
<td>RedHat 9</td>
<td>x86_64, arm64</td>
</tr>
<tr>
<td>Rocky 8</td>
<td>x86_64, arm64</td>
</tr>
<tr>
<td>Rocky 9</td>
<td>x86_64, arm64</td>
</tr>
</tbody>
</table>
<p>You can exclude instances types by family or specific instance type.
By default the InstanceConfig excludes older generation instance families.</p>
<p>You can include instances by family or specific instance type.
If no includes are specified then all non-excluded instance types will be used.
You can also choose to only include the largest instance size within a family.
The advantage of using the max instance size is that jobs running on the instance
have the highest network bandwidth for that family and fewer instances are required
to run the same number of jobs.
This may help jobs run faster and allow jobs to wait less time for a new instance to start.
The disadvantage is higher cost if the instance is lightly loaded.</p>
<p>The default InstanceConfig includes all supported base OSes and architectures and burstable and general purpose
instance types.</p>
<ul>
<li><a href="https://github.com/aws-samples/aws-eda-slurm-cluster/blob/main/source/cdk/config_schema.py#L230-L271">default instance families</a></li>
<li><a href="https://github.com/aws-samples/aws-eda-slurm-cluster/blob/main/source/cdk/config_schema.py#L314-L319">default instance types</a></li>
<li><a href="https://github.com/aws-samples/aws-eda-slurm-cluster/blob/main/source/cdk/config_schema.py#L321-L338">default excluded instance families</a></li>
<li><a href="https://github.com/aws-samples/aws-eda-slurm-cluster/blob/main/source/cdk/config_schema.py#L340-L343">default excluded instance types</a></li>
</ul>
<p>Note that instance types and families are python regular expressions.</p>
<pre><code>slurm:
  InstanceConfig:
    Include:
      InstanceFamilies:
        - t3.*
        - m6a.*
      InstanceTypes:
        - r6a.large
</code></pre>
<p>The following InstanceConfig configures instance types recommended for EDA workloads running on CentOS.</p>
<pre><code>slurm:
  InstanceConfig:
    Include:
      InstanceFamilies:
        - c5.*
        - c6g.*
        - f1
        - m5.*
        - m6g.*
        - r5.*
        - r6g.*
        - x2gd
        - z1d
</code></pre>
<p>If you have reserved instances (RIs) or savings plans then you can configure instances so that they are always on since you are paying for them whether they are running or not.
To do this add a MinCount greater than 0 for the compute resources that contain the instance types.</p>
<pre><code>slurm:
  InstanceConfig:
    NodeCounts:
      DefaultMinCount: 1
</code></pre>
<h3 id="configure-fair-share-scheduling-optional">Configure Fair Share Scheduling (Optional)</h3>
<p>Slurm supports <a href="https://slurm.schedmd.com/fair_tree.html">fair share scheduling</a>, but it requires the fair share policy to be configured.
By default, all users will be put into a default group that has a low fair share.
The configuration file is at <a href="https://github.com/aws-samples/aws-eda-slurm-cluster/blob/main/source/resources/playbooks/roles/ParallelClusterHeadNode/files/opt/slurm/config/accounts.yml.example">source/resources/playbooks/roles/ParallelClusterHeadNode/files/opt/slurm/config/accounts.yml.example</a>
in the repository and is deployed to <strong>/opt/slurm/{{ClusterName}}/conf/accounts.yml</strong>.</p>
<p>The file is a simple yaml file that allows you to configure groups, the users that belong to the group, and a fair share weight for the group.
Refer to the Slurm documentation for details on how the fair share weight is calculated.
The scheduler can be configured so that users who aren't getting their fair share of resources get
higher priority.
The following shows 3 top level groups.
Note that the fairshare weights aren't a percentage. They are just a relative weight.
In this example, the projects have 9 times higher weight than the jenkins group.</p>
<pre><code>jenkins:
  fairshare: 10
  users:
  - jenkins

project1:
  fairshare: 90

project2:
  fairshare: 90
</code></pre>
<p>The allocation of top level groups can be further subdivided to control the
relative priority of jobs within that group.
For example, a project may have design verification (dv), rtl design (rtl), physical design (dv),
and formal verification (fv) teams.
The following example shows how the project's allocation can be prioritized for the different teams.
If a group is using more than it's fair share then its jobs will have lower priority than
jobs whose users aren't getting their fair share.</p>
<pre><code>project1-dv:
  parent: project1
  fairshare: 80
  users:
  - dvuser1
project1-pd:
  parent: project1
  fairshare: 10
  users:
  - pduser1
project1-rtl:
  parent: project1
  fairshare: 10
  users:
  - rtluser1
project1-fv:
  parent: project1
  fairshare: 10
  users:
  - fvuser1
</code></pre>
<p>The scheduler uses the <strong>priority/multifactor</strong> plugin to calculate job priorities.
Fair share is just one of the factors.
Read the <a href="https://slurm.schedmd.com/priority_multifactor.html">Multifactor Priority Plugin</a> documentation
for the details.</p>
<p>This is the default configuration in slurm.conf.
The partition weight is set the highest so that jobs in the interactive partition always have the highest priority.
Fairshare and QOS are the next highest weighted factors.
The next factor is the job age, which means all else being equal the jobs run in FIFO order with the jobs that have been waiting
the longest getting higher priority.</p>
<pre><code>PriorityType=priority/multifactor
PriorityWeightPartition=100000
PriorityWeightFairshare=10000
PriorityWeightQOS=10000
PriorityWeightAge=1000
PriorityWeightAssoc=0
PriorityWeightJobSize=0
</code></pre>
<p>These weights can be adjusted based on your needs to control job priorities.</p>
<h3 id="configure-licenses">Configure Licenses</h3>
<p>Slurm supports <a href="https://slurm.schedmd.com/licenses.html">configuring licenses as a consumable resource</a>.
It will keep track of how many running jobs are using a license and when no more licenses are available
then jobs will stay pending in the queue until a job completes and frees up a license.
Combined with the fairshare algorithm, this can prevent users from monopolizing licenses and preventing others from
being able to run their jobs.</p>
<p>Licenses are configured using the <a href="../config/#licenses">slurm/Licenses</a> configuration variable.
If you are using the Slurm database then these will be configured in the database.
Otherwise they will be configured in <strong>/opt/slurm/{{ClusterName}}/etc/pcluster/custom_slurm_settings_include_file_slurm.conf</strong>.</p>
<p>The example configuration shows how the number of licenses can be configured.
In this example, the cluster will manage 800 vcs licenses and 1 ansys license.
Users must request a license using the <strong>-L</strong> or <strong>--licenses</strong> options.</p>
<pre><code>slurm:
  Licenses:
    vcs:
      Count: 800
    ansys:
      Count: 1
</code></pre>
<h3 id="configure-file-systems">Configure File Systems</h3>
<p>The Storage/ExtraMounts parameter allows you to configure additional file systems to mount on compute nodes.
Note that the security groups for the file systems must allow connections from the compute nodes.</p>
<h4 id="lustre">Lustre</h4>
<p>The following example shows how to add an FSx for Lustre file system.
The mount information can be found from the FSx console.</p>
<pre><code>  storage:
    ExtraMounts
      - dest: /lustre
        src: &lt;FileSystemId&gt;.fsx.&lt;Region&gt;.amazonaws.com@tcp:/&lt;MountName&gt;
        StorageType: FsxLustre
        FileSystemId: &lt;FileSystemId&gt;
        type: lustre
        options: relatime,flock
</code></pre>
<h4 id="ontap">ONTAP</h4>
<p>The following example shows how to add an FSx for NetApp ONTAP file system.
The mount information can be found from the FSx console.</p>
<pre><code>  storage:
    ExtraMounts
      - dest: /ontap
        src: &lt;SvmId&gt;.&lt;FileSystemId&gt;.fsx.&lt;Region&gt;.amazonaws.com:/vol1
        StorageType: FsxOntap
        FileSystemId: &lt;FileSystemId&gt;
        VolumeId: &lt;VolumeId&gt;
        type: nfs
        options: default
</code></pre>
<h4 id="zfs">ZFS</h4>
<p>The following example shows how to add an FSx for OpenZFS file system.
The mount information can be found from the FSx console.</p>
<pre><code>  storage:
    ExtraMounts
      - dest: /zfs
        src: &lt;FileSystemId&gt;.fsx.&lt;Region&gt;.amazonaws.com:/fsx
        StorageType: FsxOpenZfs
        FileSystemId: &lt;FileSystemId&gt;
        VolumeId: &lt;VolumeId&gt;
        type: nfs
        options: noatime,nfsvers=3,sync,nconnect=16,rsize=1048576,wsize=1048576
</code></pre>
<h3 id="configure-custom-partitions-optional">Configure Custom Partitions (Optional)</h3>
<p>Partitions are automatically created based on spot/on-demand, instance types, and memory and core configuration.
In addition a partition called batch is created that contains all compute nodes.
Another partition called interactive is created that contains all compute nodes that has a higher priority so that its jobs are scheduled before the jobs in the batch queue.</p>
<p>You can create your own custom partitions and specify which compute nodes it uses and what its priority is relative to other partitions.
You do this by using ParallelCluster's <a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/Scheduling-v3.html#yaml-Scheduling-SlurmSettings-CustomSlurmSettings">CustomSlurmSettings</a>.</p>
<pre><code>slurm:
  ParallelClusterConfig:
    ClusterConfig:
      Scheduling:
        SlurmSettings:
          CustomSlurmSettings:
            - PartitionName: sim-16-gb
              Default: 'NO'
              PriorityTier: 1
              Nodes: sp-r7i-l-dy-sp-16-gb-1-cores-[1-100],sp-r7a-l-dy-sp-16-gb-2-cores-[1-20]
</code></pre>
<h3 id="configure-custom-headcompute-node-scripts">Configure Custom Head/Compute Node Scripts</h3>
<p>ParallelCluster support custom scripts for the head and compute nodes.</p>
<h4 id="head-node-scripts">Head Node Scripts</h4>
<p>Custom scripts for the head node are defined in the <a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/HeadNode-v3.html#HeadNode-v3-CustomActions">CustomActions</a> section of the ParallelCluster configuration.</p>
<p><strong>NOTE:</strong> The CustomActions cannot be updated once the cluster is created.</p>
<pre><code>slurm:
  ParallelClusterConfig:
    ClusterConfig:
      HeadNode:
        CustomActions:
          OnNodeStart:
            Sequence:
              - Script: string
                Args:
                  - string
          OnNodeConfigured:
            Sequence:
              - Script: string
                Args:
                  - string
          OnNodeUpdated:
            Sequence:
              - Script: string
                Args:
                  - string
</code></pre>
<p>When the cluster is created, the following two scripts are created that you can locally modify on the head node to customize the actions that are taken when the head node is updated.</p>
<ul>
<li>/opt/slurm/config/bin/on_head_node_updated_prolog.sh</li>
<li>/opt/slurm/config/bin/on_head_node_updated_epilog.sh</li>
</ul>
<p>These scripts are called at the beginning and end of the <code>on_head_node_updated.sh</code> script.</p>
<h4 id="compute-node-scripts">Compute Node Scripts</h4>
<p>If the following scripts exist they will be executed at the beginning and end of the <code>on_compute_node_configured.sh</code> script:</p>
<ul>
<li>/opt/slurm/config/bin/on_compute_node_configured_custom_prolog.sh</li>
<li>/opt/slurm/config/bin/on_compute_node_configured_custom_epilog.sh</li>
</ul>
<p>You can also add additional scripts to all of the ParallelCluster compute nodes that will be prepended to the <a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/Scheduling-v3.html#Scheduling-v3-SlurmQueues-CustomActions">CustomActions</a> arrays in the ParallelCluster queues.</p>
<p><strong>NOTE:</strong> Updating these configuration parameters either requires the cluster to be stopped or the QueueUpdateStrategy to be set.</p>
<p>The custom scripts are declared using the following configuration parameters.</p>
<pre><code>slurm:
  ParallelClusterConfig:
    ComputeNodeCustomActions:
      OnNodeStart:
        Sequence:
          - Script: string
            Args:
              - string
      OnNodeConfigured:
        Sequence:
          - Script: string
            Args:
              - string
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
