<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Deploy AWS ParallelCluster - EDA SLURM Cluster on AWS</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="..">EDA SLURM Cluster on AWS</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">AWS EDA Slurm Cluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../deployment-prerequisites/" class="nav-link">Deployment Prerequisites</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">Deploy AWS ParallelCluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../config/" class="nav-link">Configuraton File Format</a>
                            </li>
                            <li class="navitem">
                                <a href="../res_integration/" class="nav-link">RES Integration</a>
                            </li>
                            <li class="navitem">
                                <a href="../soca_integration/" class="nav-link">SOCA Integration</a>
                            </li>
                            <li class="navitem">
                                <a href="../custom-amis/" class="nav-link">Custom AMIs for ParallelCluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../run_jobs/" class="nav-link">Run Jobs</a>
                            </li>
                            <li class="navitem">
                                <a href="../job_preemption/" class="nav-link">Job Preemption</a>
                            </li>
                            <li class="navitem">
                                <a href="../rest_api/" class="nav-link">Slurm REST API</a>
                            </li>
                            <li class="navitem">
                                <a href="../onprem/" class="nav-link">On-Premises Integration</a>
                            </li>
                            <li class="navitem">
                                <a href="../delete-cluster/" class="nav-link">Delete Cluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../debug/" class="nav-link">Debug</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../deployment-prerequisites/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../config/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/aws-samples/aws-eda-slurm-cluster/edit/master/docs/deploy-parallel-cluster.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#deploy-aws-parallelcluster" class="nav-link">Deploy AWS ParallelCluster</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#prerequisites" class="nav-link">Prerequisites</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#create-parallelcluster-ui-optional-but-recommended" class="nav-link">Create ParallelCluster UI (optional but recommended)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#create-parallelcluster-slurm-database" class="nav-link">Create ParallelCluster Slurm Database</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#create-the-cluster" class="nav-link">Create the Cluster</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#create-users_groupsjson" class="nav-link">Create users_groups.json</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#configure-submission-hosts-to-use-the-cluster" class="nav-link">Configure submission hosts to use the cluster</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#customize-the-compute-node-ami" class="nav-link">Customize the compute node AMI</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#run-your-first-job" class="nav-link">Run Your First Job</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#slurm-documentation" class="nav-link">Slurm Documentation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="deploy-aws-parallelcluster">Deploy AWS ParallelCluster</h1>
<p>A ParallelCluster configuration will be generated and used to create a ParallelCluster slurm cluster.
The first supported ParallelCluster version is 3.6.0.
Version 3.7.0 is the recommended minimum version because it supports compute node weighting that is proportional to instance type
cost so that the least expensive instance types that meet job requirements are used.
The current latest version is 3.8.0.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>See <a href="../deployment-prerequisites/">Deployment Prerequisites</a> page.</p>
<h3 id="create-parallelcluster-ui-optional-but-recommended">Create ParallelCluster UI (optional but recommended)</h3>
<p>It is highly recommended to create a ParallelCluster UI to manage your ParallelCluster clusters.
A different UI is required for each version of ParallelCluster that you are using.
The versions are list in the <a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/document_history.html">ParallelCluster Release Notes</a>.
The minimum required version is 3.6.0 which adds support for RHEL 8 and increases the number of allows queues and compute resources.
The suggested version is at least 3.7.0 because it adds configurable compute node weights which we use to prioritize the selection of
compute nodes by their cost.</p>
<p>The instructions are in the <a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/install-pcui-v3.html">ParallelCluster User Guide</a>.</p>
<h3 id="create-parallelcluster-slurm-database">Create ParallelCluster Slurm Database</h3>
<p>The Slurm Database is required for configuring Slurm accounts, users, groups, and fair share scheduling.
It you need these and other features then you will need to create a ParallelCluster Slurm Database.
You do not need to create a new database for each cluster; multiple clusters can share the same database.
Follow the directions in this <a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/tutorials_07_slurm-accounting-v3.html#slurm-accounting-db-stack-v3">ParallelCluster tutorial to configure slurm accounting</a>.</p>
<h2 id="create-the-cluster">Create the Cluster</h2>
<p>To install the cluster run the install script. You can override some parameters in the config file
with command line arguments, however it is better to specify all of the parameters in the config file.</p>
<pre><code>./install.sh --config-file &lt;config-file&gt; --cdk-cmd create
</code></pre>
<p>This will create the ParallelCuster configuration file, store it in S3, and then use a lambda function to create the cluster.</p>
<p>If you look in CloudFormation you will see 2 new stacks when deployment is finished.
The first is the configuration stack and the second is the cluster.</p>
<h2 id="create-users_groupsjson">Create users_groups.json</h2>
<p><strong>NOTE</strong>: If you are using RES and specify RESEnvironmentName in your configuration, these steps will automatically be done for you.</p>
<p>Before you can use the cluster you must configure the Linux users and groups for the head and compute nodes.
One way to do that would be to join the cluster to your domain.
But joining each compute node to a domain effectively creates a distributed denial of service (DDOS) attack on the demain controller
when the cluster rapidly scales out or in and each node tries to join or leave the domain.
This can lead to domain controller timeouts and widespread havoc in your environment.</p>
<p>To solve this problem a script runs on a server that is joined to the domain which writes a JSON file with all
of the non-privileged users and groups and their respective uids and gids.
A script and cron job on the head and compute nodes reads this json file to create local users and groups that match the domain-joined servers.</p>
<p>Select the server that you want to use to create and update the JSON file.
The outputs of the configuration stack have the commands required.</p>
<table>
<thead>
<tr>
<th>Config Stack Output</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Command01_MountHeadNodeNfs</td>
<td>Mounts the Slurm cluster's shared file system at /opt/slurm/{{ClusterName}}. This provides access to the configuration script used in the next step.</td>
</tr>
<tr>
<td>Command02_CreateUsersGroupsJsonConfigure</td>
<td>Create /opt/slurm/{{ClusterName}}/config/users_groups.json and create a cron job to refresh it hourly. Update /etc/fstab with the mount in the previous step.</td>
</tr>
</tbody>
</table>
<p>Before deleting the cluster you can undo the configuration by running the commands in the following outputs.</p>
<table>
<thead>
<tr>
<th>Config Stack Output</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>command10_CreateUsersGroupsJsonDeconfigure</td>
<td>Removes the crontab that refreshes users_groups.json.</td>
</tr>
</tbody>
</table>
<p>Now the cluster is ready to be used by sshing into the head node or a login node, if you configured one.</p>
<p>If you configured extra file systems for the cluster that contain the users' home directories, then they should be able to ssh
in with their own ssh keys.</p>
<h2 id="configure-submission-hosts-to-use-the-cluster">Configure submission hosts to use the cluster</h2>
<p><strong>NOTE</strong>: If you are using RES and specify RESEnvironmentName in your configuration, these steps will automatically be done for you on all running DCV desktops.</p>
<p>ParallelCluster was built assuming that users would ssh into the head node or login nodes to execute Slurm commands.
This can be undesirable for a number of reasons.
First, users shouldn't be given ssh access to a critical infrastructure like the cluster head node.
With ParallelCluster 3.7.0 you can configure login nodes, but if you have already provisioned desktop nodes then
it's wasteful to have to provision login nodes.
Second, it's just inconvenient to have to use ssh to access the cluster and use it.</p>
<p>Fortunately, you can configure any server as a submission host so that users can run slurm commands.
These commands must be run by an administrator that has root access to the submission host.
The commands could also be run to create a custom AMI for user desktops so that they can access the clusters.
The commands to configure submission hosts are in the outputs of the configuration CloudFormation stack.
Run them in the following order:</p>
<table>
<thead>
<tr>
<th>Config Stack Output</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Command01_MountHeadNodeNfs</td>
<td>Mounts the Slurm cluster's shared file system at /opt/slurm/{{ClusterName}}. This provides access to the configuration script used in the next step.</td>
</tr>
<tr>
<td>Command03_SubmitterConfigure</td>
<td>Configure the submission host so it can directly access the Slurm cluster.  Update /etc/fstab with the mount in the previous step.</td>
</tr>
</tbody>
</table>
<p>The first command simply mounts the head node's NFS file system so you have access to the Slurm commands and configuration.</p>
<p>The second command runs an ansible playbook that configures the submission host so that it can run the Slurm commands for the cluster.
It will also compile the Slurm binaries for the OS distribution and CPU architecture of your host.
It also configures the modulefile that sets up the environment to use the slurm cluster.</p>
<p><strong>NOTE</strong>: When the new modulefile is created, you need to refresh your shell environment before the modulefile
can be used.
You can do this by opening a new shell or by sourcing your .profile: <code>source ~/.profile</code>.</p>
<p>The clusters have been configured so that a submission host can use more than one cluster by simply changing the modulefile that is loaded.</p>
<p>On the submission host just open a new shell and load the modulefile for your cluster and you can access Slurm.</p>
<h2 id="customize-the-compute-node-ami">Customize the compute node AMI</h2>
<p>The easiest way to create a custom AMI is to find the default ParallelCluster AMI in the UI.
Create an instance using the AMI and make whatever customizations you require such as installing packages and
configuring users and groups.</p>
<p>Custom file system mounts can be configured in the aws-eda-slurm-cluster config file which will add it to the
ParallelCluster config file so that ParallelCluster can manage them for you.</p>
<p>When you are done create a new AMI and wait for the AMI to become available.
After it is available you can add the custom ami to the aws-eda-slurm-cluster config file.</p>
<pre><code>slurm:
  ParallelClusterConfig:
    ComputeNodeAmi: ami-0fdb972bda05d2932
</code></pre>
<p>Then update your aws-eda-slurm-cluster stack by running the install script again.</p>
<h2 id="run-your-first-job">Run Your First Job</h2>
<p>Run the following command in a shell to configure your environment to use your slurm cluster.</p>
<p><strong>NOTE</strong>: When the new modulefile is created, you need to refresh your shell environment before the modulefile
can be used.
You can do this by opening a new shell or by sourcing your profile: <code>source ~/.bash_profile</code>.</p>
<pre><code>module load {{ClusterName}}
</code></pre>
<p>If you want to get a list of all of the clusters that are available execute the following command.</p>
<pre><code>module avail
</code></pre>
<p>To submit a job run the following command.</p>
<pre><code>sbatch /opt/slurm/$SLURM_CLUSTER_NAME/test/job_simple_array.sh
</code></pre>
<p>To check the status run the following command.</p>
<pre><code>squeue
</code></pre>
<p>To open an interactive shell on a slurm node.</p>
<pre><code>srun --pty /bin/bash
</code></pre>
<h2 id="slurm-documentation">Slurm Documentation</h2>
<p><a href="https://slurm.schedmd.com">https://slurm.schedmd.com</a></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
