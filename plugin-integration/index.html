<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Plugin Integration Into Existing Slurm Cluster (legacy) - EDA SLURM Cluster on AWS</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="..">EDA SLURM Cluster on AWS</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">AWS EDA Slurm Cluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../deployment-prerequisites/" class="nav-link">Deployment Prerequisites</a>
                            </li>
                            <li class="navitem">
                                <a href="../deploy-parallel-cluster/" class="nav-link">Deploy ParallelCluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../soca_integration/" class="nav-link">SOCA Integration</a>
                            </li>
                            <li class="navitem">
                                <a href="../run_jobs/" class="nav-link">Run Jobs</a>
                            </li>
                            <li class="navitem">
                                <a href="../job_preemption/" class="nav-link">Job Preemption</a>
                            </li>
                            <li class="navitem">
                                <a href="../rest_api/" class="nav-link">Slurm REST API</a>
                            </li>
                            <li class="navitem">
                                <a href="../deploy-legacy-cluster/" class="nav-link">Deploy Legacy Cluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../onprem/" class="nav-link">On-Premises Integration (legacy)</a>
                            </li>
                            <li class="navitem">
                                <a href="../f1-ami/" class="nav-link">SLURM AMI Based On FPGA Developer AMI (legacy)</a>
                            </li>
                            <li class="navitem">
                                <a href="../federation/" class="nav-link">Federation (legacy)</a>
                            </li>
                            <li class="navitem">
                                <a href="../multi-region/" class="nav-link">Multi-AZ and Multi-Region Support (legacy)</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">Plugin Integration Into Existing Slurm Cluster (legacy)</a>
                            </li>
                            <li class="navitem">
                                <a href="../delete-cluster/" class="nav-link">Delete Cluster (legacy)</a>
                            </li>
                            <li class="navitem">
                                <a href="../implementation/" class="nav-link">Implementation Details (legacy)</a>
                            </li>
                            <li class="navitem">
                                <a href="../debug/" class="nav-link">Debug</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../multi-region/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../delete-cluster/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/aws-samples/aws-eda-slurm-cluster/edit/master/docs/plugin-integration.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#plugin-integration-into-existing-slurm-cluster-legacy" class="nav-link">Plugin Integration Into Existing Slurm Cluster (legacy)</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#network-requirements" class="nav-link">Network Requirements</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#file-system-requirements" class="nav-link">File System Requirements</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#create-aws-slurm-cluster" class="nav-link">Create AWS Slurm Cluster</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#aws-credentials" class="nav-link">AWS Credentials</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#amazon-machine-images-for-compute-nodes" class="nav-link">Amazon Machine Images for Compute Nodes</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ssm-parameter-store-variables" class="nav-link">SSM Parameter Store Variables</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#slurm-configuration" class="nav-link">Slurm Configuration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="plugin-integration-into-existing-slurm-cluster-legacy">Plugin Integration Into Existing Slurm Cluster (legacy)</h1>
<p>If you have an existing Slurm cluster and want to enable it to scale into AWS then you can integrate
the <code>SlurmPlugin.py</code> into your existing cluster.
The plugin implements the Slurm power saving API scripts so the integration is as simple
as copying the plugin and it's scripts into your file system and then modifying your slurm configuration to use them.</p>
<h2 id="network-requirements">Network Requirements</h2>
<p>The instructions for integrating the AWS cluster with on-premises compute nodes contains the <a href="/onprem/#network-requirements">network requirements</a>.</p>
<p>The VPC's DNS must be configured so that it can resolve the on-prem hostnames such as the slurm controller and file systems.</p>
<h2 id="file-system-requirements">File System Requirements</h2>
<p>The compute nodes in the AWS VPC will need access to the same file systems paths as your existing compute nodes.
This can easily be accomplished by mounting your on-prem file systems across the VPN of Direct Connect connection, but
that will likely have significant latency and performance impacts.
If your on-prem file systems are NetApp Ontap then you can create <a href="https://aws.amazon.com/fsx/netapp-ontap/">Amazon FSx for NetApp Ontap</a>
file systems configured with FlexCache volumes to provide low latency, high performance caches of your on-prem file systems on AWS.
If you do not use NetApp then you can use <a href="https://aws.amazon.com/filecache/">Amazon File Cache</a> to create high performance
file caches of your on-prem file systems.</p>
<h2 id="create-aws-slurm-cluster">Create AWS Slurm Cluster</h2>
<p>The plugin requires a number of configuration files as well as AWS resources for the compute nodes such as Amazon Machine Images (AMIs),
IAM instance roles, and security groups.
The easiest way to create all of the required resources is to follow the <a href="/onprem">instructions to deploy a cluster with on-premises compute nodes</a>
into your AWS VPC and then use those resources to configure your existing cluster.
Note that <code>slurm_nodes_on_prem.conf</code> can be empty and doesn't have to include any on-prem compute nodes.
The configuration file should include the file systems that should be mounted on the AWS compute nodes.</p>
<p>After you've deployed the AWS cluster,
Mount the slurm file system on your slurm controller at</p>
<pre>/opt/slurm/<b><i>cluster-name</i></b></pre>

<h2 id="aws-credentials">AWS Credentials</h2>
<p>The power saving scripts run as the <code>slurm</code> user on your slurm controller and require AWS IAM permissions
to orchestrate AWS instances for your Slurm cluster.
Specifically, the slurm controller needs access to the AMIs and permission to start, stop, and terminate EC2 instances.
The permissions are defined in the SlurmCtlPolicy resource of the cluster's Cloudformation stack.
You can create a <code>slurm</code> IAM user and attach the SlurmCtlPolicy.
Then you can create IAM credentials for the <code>slurm</code> user and save them on the slurm controller using <code>aws config</code>.</p>
<h2 id="amazon-machine-images-for-compute-nodes">Amazon Machine Images for Compute Nodes</h2>
<p>You can modify the AMIs created by the AWS slurm cluster for use by your on-prem cluster.</p>
<h2 id="ssm-parameter-store-variables">SSM Parameter Store Variables</h2>
<p>The plugin reads serveral SSM parameters to get information that it needs to orchestrate instances.</p>
<table>
<thead>
<tr>
<th>SSM Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><pre>/<b><i>cluster-name</i></b>/SlurmNodeAmi/<b><i>os-distribution</i></b>/<b><i>os-major-version</i></b>/<b><i>architecture</i></b>/<b><i>region</i></b></pre></td>
<td>AMIs for AWS EC2 compute nodes</td>
</tr>
<tr>
<td><pre>/<b><i>cluster-name</i></b>/SlurmNodeEc2KeyPairs/<b><i>region</i></b></pre></td>
<td>EC2 Keypairs for each region</td>
</tr>
<tr>
<td><pre>/<b><i>cluster-name</i></b>/SlurmNodeSecurityGroups/<b><i>region</i></b></pre></td>
<td>Security groups for AWS EC2 compute nodes</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Field</th>
<th>Valid Values</th>
</tr>
</thead>
<tbody>
<tr>
<td>os-distribution</td>
<td>AlmaLinux | Amazon | CentOS | RedHat | Rocky</td>
</tr>
<tr>
<td>architecture</td>
<td>arm64 | x86_64</td>
</tr>
</tbody>
</table>
<h2 id="slurm-configuration">Slurm Configuration</h2>
<p>The existing slurm cluster's configuration file will need to be updated to to configure the AWS compute nodes
and to use the <code>SlurmPlugin.py</code>.</p>
<p>Update your <code>slurm.conf</code> based on <code>/opt/slurm/slurmaws/etc/slurm.conf</code>.
At a minimum you will need to add the following lines.</p>
<pre><code># CommunicationParameters:
# NoAddrCache: Do not assume that nodes will retain their IP addresses. Do not cache node-&gt;ip mapping
CommunicationParameters = NoAddrCache

# ReturnToService
# 0: Make node available if it registers with a valid configuration regardless of why it is down.
# 1: Only return to service if DOWN due to being non-responsive.
# 2: A DOWN node will become available for use upon registration with a valid configuration.
ReturnToService=2

# TreeWidth is set to the maximum for cloud clusters so messages go directly between controller and nodes.
# https://slurm.schedmd.com/elastic_computing.html
TreeWidth = 65533

#
# SlurmctldParameters
# cloud_dns: Do not set cloud_dns unless joining the domain and adding nodes to DNS
#     Joining the domain overloads the DCs when lots of nodes are started so
#     not joining the domain or using cloud_dns.
# idle_on_node_suspend: Mark nodes as idle, regardless of current state, when suspending
#     nodes with SuspendProgram so that nodes will be eligible to be resumed at a later time.
# node_reg_mem_percent: Percentage of memory a node is allowed to register with without being marked as invalid with low memory.
#     Use this so can configure nodes with 100% of their memory.
#     Without this option the node will fail because the system uses some of the memory.
SlurmctldParameters=\
idle_on_node_suspend,\
,node_reg_mem_percent=90
#
# Allow users to see state of nodes that are powered down
PrivateData = cloud

#
# POWER SAVE SUPPORT FOR IDLE NODES
#
SuspendProgram = /opt/slurm/slurmaws/bin/slurm_ec2_stop.py
ResumeProgram = /opt/slurm/slurmaws/bin/slurm_ec2_resume.py
ResumeFailProgram = /opt/slurm/slurmaws/bin/slurm_ec2_resume_fail.py
# Maximum time between when a node is suspended and when suspend is complete.
# At that time it should be ready to be resumed.
SuspendTimeout = 60
ResumeTimeout = 600
# Number of nodes per minute that can be resumed or suspended
ResumeRate = 300
SuspendRate = 60
# Time that a node has to be idle or down before being suspended
# Should be &gt;= (SuspendTimeout + ResumeTimeout)
SuspendTime = 660

include /opt/slurm/slurmaws/etc/slurm_nodes.conf
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
