<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>RES Integration - EDA SLURM Cluster on AWS</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="..">EDA SLURM Cluster on AWS</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">AWS EDA Slurm Cluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../deployment-prerequisites/" class="nav-link">Deployment Prerequisites</a>
                            </li>
                            <li class="navitem">
                                <a href="../security-groups/" class="nav-link">Security Groups</a>
                            </li>
                            <li class="navitem">
                                <a href="../deploy-parallel-cluster/" class="nav-link">Deploy AWS ParallelCluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../config/" class="nav-link">Configuraton File Format</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">RES Integration</a>
                            </li>
                            <li class="navitem">
                                <a href="../soca_integration/" class="nav-link">SOCA Integration</a>
                            </li>
                            <li class="navitem">
                                <a href="../custom-amis/" class="nav-link">Custom AMIs for ParallelCluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../run_jobs/" class="nav-link">Run Jobs</a>
                            </li>
                            <li class="navitem">
                                <a href="../job_preemption/" class="nav-link">Job Preemption</a>
                            </li>
                            <li class="navitem">
                                <a href="../rest_api/" class="nav-link">Slurm REST API</a>
                            </li>
                            <li class="navitem">
                                <a href="../onprem/" class="nav-link">On-Premises Integration</a>
                            </li>
                            <li class="navitem">
                                <a href="../delete-cluster/" class="nav-link">Delete Cluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../debug/" class="nav-link">Debug</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../config/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../soca_integration/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/aws-samples/aws-eda-slurm-cluster/edit/master/docs/res_integration.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#res-integration" class="nav-link">RES Integration</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#res-setup" class="nav-link">RES Setup</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#onboard-your-file-systems" class="nav-link">Onboard your file systems</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#create-res-project" class="nav-link">Create RES Project</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#give-the-project-access-to-software-stacks" class="nav-link">Give the project access to software stacks</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#create-virtual-desktop" class="nav-link">Create virtual desktop</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#parallelcluster-configurattion" class="nav-link">ParallelCluster Configurattion</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#connect-to-the-virtual-desktop" class="nav-link">Connect to the virtual desktop</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#create-custom-ami-for-virtual-desktops" class="nav-link">Create custom AMI for virtual desktops</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="res-integration">RES Integration</h1>
<p>First you will need to deploy RES.
The easiest way is to <a href="https://docs.aws.amazon.com/res/latest/ug/create-demo-env.html">deploy the demo environment</a> which provides all of the prerequisites and completely automates the deployment.
If you want to use an existing VPC or Active Directory, then you will need to follow the instructions to <a href="https://docs.aws.amazon.com/res/latest/ug/deploy-the-product.html">deploy the product</a>.</p>
<h2 id="res-setup">RES Setup</h2>
<p>After you've deployed RES, you need to configure it so that the remote desktops can be used as external login nodes and so that they have access to any file systems that you created.</p>
<h3 id="onboard-your-file-systems">Onboard your file systems</h3>
<p>RES natively supports EFS, FSx for NetApp Ontap, and FSx for Lustre file systems.
It can create them for you or you can onboard existing file systems.</p>
<ul>
<li>Expand <strong>Environment Management</strong></li>
<li>Click <strong>File Systems</strong></li>
<li>Click <strong>Onboard File System</strong> or <strong>Create File System</strong></li>
</ul>
<h3 id="create-res-project">Create RES Project</h3>
<ul>
<li>Expand <strong>Environment Management</strong></li>
<li>Click <strong>Projects</strong></li>
<li>Click <strong>Create Project</strong></li>
<li>Fill in the required fields.</li>
<li>Add any file systems that you created so they will be automatically mounted on the desktops that belong to the project.</li>
<li>Expand <strong>Advanced Options</strong> under <strong>Resource Configurations</strong> and add the <strong>SlurmLoginNodeSG</strong> so that it will be attached automatically to the remote desktop so they can access the external file systems and slurm clusters.</li>
<li>Add the groups and users that can use the project.</li>
</ul>
<h3 id="give-the-project-access-to-software-stacks">Give the project access to software stacks</h3>
<p>Next, you'll need to give the project access to a Software Stack.
You can either create a new Software Stack or update an existing one.</p>
<ul>
<li>Select <strong>Software Stacks</strong> under <strong>Session Management</strong>.</li>
<li>Select an existing stack like the RHEL 8 stack</li>
<li>Select <strong>Actions</strong>, <strong>Edit Stack</strong>.</li>
<li>Select your project under Projects and enable it to use the stack.</li>
</ul>
<h3 id="create-virtual-desktop">Create virtual desktop</h3>
<p>Now you can create a virtual desktop using the project that you just created.</p>
<ul>
<li>Select <strong>My Virtual Desktops</strong> under <strong>Desktops</strong>.</li>
<li>Click <strong>Launch New Virtual Desktop</strong></li>
<li>Give it a descriptive name, select the project, operating system, and software stack.</li>
<li>I suggest using a t3 instance for virtual desktops, such as a t3.large. If you need more cores or memory you will use your ParallelCluster compute nodes.</li>
<li>I usually increase the storage size to 20GB so I can install additional packages.</li>
<li>Click <strong>Submit</strong> and then wait for the desktop to be provisioned. You may need to refresh the page to update the desktop status.</li>
</ul>
<p>You can switch to the EC2 console to verify that the instance has been launched and that it has the required security group attached.</p>
<h2 id="parallelcluster-configurattion">ParallelCluster Configurattion</h2>
<p>Integration with <a href="https://docs.aws.amazon.com/res/latest/ug/overview.html">Research and Engineering Studion (RES)</a> is straightforward.
You simply specify the <strong>--RESStackName</strong> option for the <code>install.sh</code> script or add the <strong>RESStackName</strong> configuration parameter
to your configuration file.
The install script will set the following configuration parameters based on your RES environment or check them if you have them set to make sure they are consistent
with your RES environment.
The intention is to completely automate the deployment of ParallelCluster and set up the RES environment so that it can easily be used.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>VpcId</td>
<td>VPC id for the RES cluster</td>
<td>vpc-xxxxxx</td>
</tr>
<tr>
<td>SubnetId</td>
<td>Subnet in the RES VPC.</td>
<td>subnet-xxxxx</td>
</tr>
<tr>
<td>slurm/ExternalLoginNodes</td>
<td>Information of instances to be configured as external login nodes</td>
<td></td>
</tr>
<tr>
<td>slurm/DomainJoinedInstance</td>
<td>Tags of cluster-manager which will be used to create users_groups.json</td>
<td></td>
</tr>
<tr>
<td>slurm/storage/ExtraMounts</td>
<td>The mount parameters for the /home directory. This is required for access to the home directory.</td>
<td></td>
</tr>
<tr>
<td>slurm/SlurmCtl/AdditionalSecurityGroups</td>
<td>Security group that allows access to EFS /home</td>
<td></td>
</tr>
<tr>
<td>slurm/InstanceConfig/AdditionalSecurityGroups</td>
<td>Security group that allows access to EFS /home</td>
<td></td>
</tr>
</tbody>
</table>
<p>You must also create security groups as described in <a href="../deployment-prerequisites/#security-groups-for-login-nodes">Security Groups for Login Nodes</a>.
You must either specify <strong>AdditionalSecurityGroupsStackName</strong> or specify the SlurmHeadNodeSG in the <code>slurm/SlurmCtl/AdditionalSecurityGroups</code> parameter and the SlurmComputeNodeSG in the <code>slurm/InstanceConfig/AdditionalSecurityGroups</code> parameter.</p>
<p>When you specify <strong>RESStackName</strong>, a lambda function will run SSM commands to create a cron job on a RES domain joined instance to update the users_groups.json file every hour. Another lambda function will also automatically configure all running VDI hosts to use the cluster.</p>
<p>The following example shows the configuration parameters for a RES cluster with a stack named res-eda.</p>
<pre><code>---
#====================================================================
# EDA Slurm cluster for RES using ParallelCluster
#
# Defaults and valid configuration options are in source/config_schema.py.
# Command line values override values in the config file.
#====================================================================

StackName: res-eda-pc-3-9-1-rhel8-x86-config

Region: &lt;region&gt;

SshKeyPair: &lt;key-name&gt;

AdditionalSecurityGroupsStackName: res-eda-SlurmSecurityGroups

RESStackName: res-eda

ErrorSnsTopicArn: &lt;topic-arn&gt;

TimeZone: 'US/Central'

slurm:
  ParallelClusterConfig:
    Version: '3.10.1'
    Image:
      Os: 'rhel8'
    Architecture: 'x86_64'
    Slurmdbd:
      SlurmdbdStackName: pcluster-slurm-dbd-res-eda-3-10-1

  SlurmCtl: {}

  # Configure typical EDA instance types
  # A partition will be created for each combination of Base OS, Architecture, and Spot
  InstanceConfig:
    UseSpot: true
    NodeCounts:
      DefaultMaxCount: 10
</code></pre>
<h2 id="connect-to-the-virtual-desktop">Connect to the virtual desktop</h2>
<p>When the cluster deployment finishes you are ready to run jobs from your RES DCV desktop.</p>
<h2 id="create-custom-ami-for-virtual-desktops">Create custom AMI for virtual desktops</h2>
<p>Connect to your virtual desktop and install packages, software, configure ParallelCluster clusters, mount file systems, and whatever else you need for your project.
You'll normally require root access to do this.
When you are done, remove the following files or else new virtual desktops created from the image will fail to provision.</p>
<pre><code>rm /root/bootstrap/semaphore/*.lock
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
