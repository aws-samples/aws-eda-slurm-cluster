<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Implementation Details - EDA SLURM Cluster on AWS</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="..">EDA SLURM Cluster on AWS</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">AWS EDA Slurm Cluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../deploy/" class="nav-link">Deploy the Cluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../run_jobs/" class="nav-link">Run Jobs</a>
                            </li>
                            <li class="navitem">
                                <a href="../job_preemption/" class="nav-link">Job Preemption</a>
                            </li>
                            <li class="navitem">
                                <a href="../rest_api/" class="nav-link">Slurm REST API</a>
                            </li>
                            <li class="navitem">
                                <a href="../onprem/" class="nav-link">On-Premises Integration</a>
                            </li>
                            <li class="navitem">
                                <a href="../soca_integration/" class="nav-link">SOCA Integration</a>
                            </li>
                            <li class="navitem">
                                <a href="../f1-ami/" class="nav-link">SLURM AMI Based On FPGA Developer AMI</a>
                            </li>
                            <li class="navitem">
                                <a href="../federation/" class="nav-link">Federation</a>
                            </li>
                            <li class="navitem">
                                <a href="../multi-region/" class="nav-link">Multi-AZ and Multi-Region Support</a>
                            </li>
                            <li class="navitem">
                                <a href="../plugin-integration/" class="nav-link">Plugin Integration Into Existing Slurm Cluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../delete-cluster/" class="nav-link">Delete Cluster</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">Implementation Details</a>
                            </li>
                            <li class="navitem">
                                <a href="../debug/" class="nav-link">Debug</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../delete-cluster/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../debug/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/aws-samples/aws-eda-slurm-cluster/edit/master/docs/implementation.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#implementation-details" class="nav-link">Implementation Details</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#slurm-infrastructure" class="nav-link">Slurm Infrastructure</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#directory-structure" class="nav-link">Directory Structure</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#cloudwatch-metrics" class="nav-link">CloudWatch Metrics</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#down-node-handling" class="nav-link">Down Node Handling</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#insufficient-capacity-exception-ice-handling" class="nav-link">Insufficient Capacity Exception (ICE) Handling</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="implementation-details">Implementation Details</h1>
<h2 id="slurm-infrastructure">Slurm Infrastructure</h2>
<p>All hosts in the cluster must share a uniform user and group namespace.</p>
<p>The munged service must be running before starting any slurm daemons.</p>
<h2 id="directory-structure">Directory Structure</h2>
<p>All of the configuration files, scripts, and logs can be found under the following directory.</p>
<pre><code>/opt/slurm/{{ClusterName}}
</code></pre>
<h2 id="cloudwatch-metrics">CloudWatch Metrics</h2>
<p>CloudWatch metrics are published by the following sources, but the code is all in <code>SlurmPlugin.py</code>.</p>
<ul>
<li>Slurm power saving scripts<ul>
<li><code>/opt/slurm/{{ClusterName}}/bin/slurm_ec2_resume.py</code></li>
<li><code>/opt/slurm/{{ClusterName}}/bin/slurm_ec2_resume_fail.py</code></li>
<li><code>/opt/slurm/{{ClusterName}}/bin/slurm_ec2_stop.py</code></li>
<li><code>/opt/slurm/{{ClusterName}}/bin/slurm_ec2_terminate.py</code></li>
</ul>
</li>
<li>Spot monitor running on compute nodes<ul>
<li><code>/opt/slurm/{{ClusterName}}/bin/spot_monitor.py</code></li>
</ul>
</li>
<li>Cron jobs running on the Slurm controller<ul>
<li><code>/opt/slurm/{{ClusterName}}/bin/slurm_ec2_publish_cw.py</code></li>
<li><code>/opt/slurm/{{ClusterName}}/bin/terminate_old_instances.py</code></li>
</ul>
</li>
</ul>
<h2 id="down-node-handling">Down Node Handling</h2>
<p>If a node has a problem running jobs then Slurm can mark it DOWN.
This includes if the resume script cannot start an instance for any reason include insufficient EC2 capacity.
This can create 2 issues. First, if the compute node is running then it is wasting EC2 costs.
Second, the node will be unavailable for scheduling which reduces the configured capacity of the cluster.</p>
<p>The cluster is configured to periodically check for DOWN nodes so that they aren't left running and wasting compute costs.
This is done by <code>/opt/slurm/{{ClusterName}}/bin/slurm_down_nodes_clean.sh</code>.</p>
<p>The script is called every day by a systemd service:</p>
<p><code>/etc/systemd/system/slurm_down_nodes_clean.service</code></p>
<p>This service is run at boot and once a day as defined in</p>
<p><code>/etc/systemd/system/slurm_down_nodes_clean.timer</code></p>
<h2 id="insufficient-capacity-exception-ice-handling">Insufficient Capacity Exception (ICE) Handling</h2>
<p>When Slurm schedules a powered down node it calls the ResumeScript defined in <code>slurm.conf</code>.
This is in <code>/opt/slurm/{{ClusterName}}/bin/slurm_ec2_resume.py</code>.
The script will attempt to start an EC2 instance and if it receives and InsufficientCapacityException (ICE) then the node will be marked down and Slurm will requeue the job.
However, this is inadequate because if there are a large number of instances of that instance type configured then
Slurm will schedule them and try to start them with the same result.
Eventually all of the powered down nodes will be marked DOWN and depending on the job requirements the job will be allocated
to a node with a different instance type or it will fail.
This can take a substantial amount of time so <code>SlurmPlugin.py</code> does the following when it receives an ICE.</p>
<ul>
<li>Mark the node as DRAIN so no new jobs are scheduled on it.</li>
<li>Find all other powered down nodes of the same type and mark them DOWN so that they won't be scheduled after this node is marked DOWN. Nodes that are running will be left alone.</li>
<li>Requeue jobs on the node that failed to resume because of ICE.</li>
<li>Mark the node DOWN.</li>
<li>Power down the node. This is so that Slurm knows that the node is powered down so that when it is marked IDLE it will be powered up when a job is scheduled on it.</li>
<li>The <code>slurm_down_nodes_clean.service</code> periodically finds all DOWN Slurm nodes, powers them down, and then marks them IDLE so that they can have jobs scheduled on them. This will allow Slurm to attempt to use more nodes of the instance type in the hopes that there is more capacity. If not, then the cycle repeats.</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
