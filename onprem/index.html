<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>On-Premises Integration - EDA SLURM Cluster on AWS</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="..">EDA SLURM Cluster on AWS</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">AWS EDA Slurm Cluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../deployment-prerequisites/" class="nav-link">Deployment Prerequisites</a>
                            </li>
                            <li class="navitem">
                                <a href="../deploy-parallel-cluster/" class="nav-link">Deploy AWS ParallelCluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../res_integration/" class="nav-link">RES Integration</a>
                            </li>
                            <li class="navitem">
                                <a href="../soca_integration/" class="nav-link">SOCA Integration</a>
                            </li>
                            <li class="navitem">
                                <a href="../custom-amis/" class="nav-link">Custom AMIs for ParallelCluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../run_jobs/" class="nav-link">Run Jobs</a>
                            </li>
                            <li class="navitem">
                                <a href="../job_preemption/" class="nav-link">Job Preemption</a>
                            </li>
                            <li class="navitem">
                                <a href="../rest_api/" class="nav-link">Slurm REST API</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">On-Premises Integration</a>
                            </li>
                            <li class="navitem">
                                <a href="../delete-cluster/" class="nav-link">Delete Cluster</a>
                            </li>
                            <li class="navitem">
                                <a href="../debug/" class="nav-link">Debug</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../rest_api/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../delete-cluster/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/aws-samples/aws-eda-slurm-cluster/edit/master/docs/onprem.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#on-premises-integration" class="nav-link">On-Premises Integration</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#network-requirements" class="nav-link">Network Requirements</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#dns-requirements" class="nav-link">DNS Requirements</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#file-system-requirements" class="nav-link">File System Requirements</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#slurm-configuration-of-on-premises-compute-nodes" class="nav-link">Slurm Configuration of On-Premises Compute Nodes</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#simulating-an-on-premises-network-using-aws" class="nav-link">Simulating an On-Premises Network Using AWS</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="on-premises-integration">On-Premises Integration</h1>
<p>The Slurm cluster can also be configured to manage on-premises compute nodes.
The user must configure the on-premises compute nodes and then give the configuration information.</p>
<h2 id="network-requirements">Network Requirements</h2>
<p>The on-prem network must have a CIDR range that doesn't overlap the Slurm cluster's VPC and the two networks
need to be connected using VPN or AWS Direct Connect.
The on-prem firewall must allow ingress and egress from the VPC.
The ports are used to connect to the file systems, slurm controllers, and allow traffic between virtual desktops and compute nodes.</p>
<h2 id="dns-requirements">DNS Requirements</h2>
<p>Local network DNS must have an entry for the slurm controller or have a forwarding rule to the AWS provided DNS in the Slurm VPC.</p>
<h2 id="file-system-requirements">File System Requirements</h2>
<p>All of the compute nodes in the cluster, including the on-prem nodes, must have file system mounts that replicate the same directory structure.
This can involve mounting filesystems across VPN or Direct Connect or synchronizing file systems using tools like rsync or NetApp FlexCache or SnapMirror.
Performance will dictate the architecture of the file system.</p>
<p>The onprem compute nodes must mount the Slurm controller's NFS export so that they have access to the Slurm binaries and configuration file.
They must then be configured to run slurmd so that they can be managed by Slurm.</p>
<h2 id="slurm-configuration-of-on-premises-compute-nodes">Slurm Configuration of On-Premises Compute Nodes</h2>
<p>The slurm cluster's configuration file allows the configuration of on-premises compute nodes.
The Slurm cluster will not provision any of the on-prem nodes, network, or firewall, but it will configure
the cluster's resources to be used by the on-prem nodes.
All that needs to be configured are the configuration file for the on-prem nodes and the CIDR block.</p>
<pre><code>  InstanceConfig:
    OnPremComputeNodes:
      ConfigFile: 'slurm_nodes_on_prem.conf'
      CIDR: '10.1.0.0/16'
</code></pre>
<p><code>slurm_nodes_on_prem.conf</code></p>
<pre><code>#
# ON PREMISES COMPUTE NODES
#
# Config file with list of statically provisioned on-premises compute nodes that
# are managed by this cluster.
#
# These nodes must be addressable on the network and firewalls must allow access on all ports
# required by slurm.
#
# The compute nodes must have mounts that mirror the compute cluster including mounting the slurm file system
# or a mirror of it.
NodeName=Default State=DOWN

NodeName=onprem-c7-x86-t3-2xl-0 NodeAddr=onprem-c7-x86-t3-2xl-0.onprem.com  CPUs=4  RealMemory=30512   Feature=c7,CentOS_7_x86_64,x86_64,GHz:2.5 Weight=1
NodeName=onprem-c7-x86-t3-2xl-1 NodeAddr=onprem-c7-x86-t3-2xl-1.onprem.com  CPUs=4  RealMemory=30512   Feature=c7,CentOS_7_x86_64,x86_64,GHz:2.5 Weight=1
NodeName=onprem-c7-x86-t3-2xl-2 NodeAddr=onprem-c7-x86-t3-2xl-2.onprem.com  CPUs=4  RealMemory=30512   Feature=c7,CentOS_7_x86_64,x86_64,GHz:2.5 Weight=1
NodeName=onprem-c7-x86-t3-2xl-3 NodeAddr=onprem-c7-x86-t3-2xl-3.onprem.com  CPUs=4  RealMemory=30512   Feature=c7,CentOS_7_x86_64,x86_64,GHz:2.5 Weight=1
NodeName=onprem-c7-x86-t3-2xl-4 NodeAddr=onprem-c7-x86-t3-2xl-4.onprem.com  CPUs=4  RealMemory=30512   Feature=c7,CentOS_7_x86_64,x86_64,GHz:2.5 Weight=1
NodeName=onprem-c7-x86-t3-2xl-5 NodeAddr=onprem-c7-x86-t3-2xl-5.onprem.com  CPUs=4  RealMemory=30512   Feature=c7,CentOS_7_x86_64,x86_64,GHz:2.5 Weight=1
NodeName=onprem-c7-x86-t3-2xl-6 NodeAddr=onprem-c7-x86-t3-2xl-6.onprem.com  CPUs=4  RealMemory=30512   Feature=c7,CentOS_7_x86_64,x86_64,GHz:2.5 Weight=1
NodeName=onprem-c7-x86-t3-2xl-7 NodeAddr=onprem-c7-x86-t3-2xl-7.onprem.com  CPUs=4  RealMemory=30512   Feature=c7,CentOS_7_x86_64,x86_64,GHz:2.5 Weight=1
NodeName=onprem-c7-x86-t3-2xl-8 NodeAddr=onprem-c7-x86-t3-2xl-8.onprem.com  CPUs=4  RealMemory=30512   Feature=c7,CentOS_7_x86_64,x86_64,GHz:2.5 Weight=1
NodeName=onprem-c7-x86-t3-2xl-9 NodeAddr=onprem-c7-x86-t3-2xl-9.onprem.com  CPUs=4  RealMemory=30512   Feature=c7,CentOS_7_x86_64,x86_64,GHz:2.5 Weight=1

#
#
# OnPrem Partition
#
# The is the default partition and includes all nodes from the 1st OS.
#
PartitionName=onprem Default=YES PriorityTier=20000 Nodes=\
onprem-c7-x86-t3-2xl-[0-9]

#
# Always on partitions
#
SuspendExcParts=onprem

</code></pre>
<h2 id="simulating-an-on-premises-network-using-aws">Simulating an On-Premises Network Using AWS</h2>
<p>Create a new VPC with public and private subnets and NAT gateways.
To simulate the latency between an AWS region and on-prem you can create the VPC in a different region in your account.
The CIDR must not overlap with the Slurm VPC.</p>
<p>Create a VPC peering connection to your Slurm VPC and accept the connection in the Slurm VPC.
Create routes in the private subnets for the CIDR of the peered VPC and route it to the vpc peering connection.</p>
<p>Add the on-prem VPC to the Slurm VPC's Route53 private local zone.</p>
<p>Create a Route53 private hosted zone for the on-prem compute nodes and add it to the onprem VPC and the slurm VPC so that onprem compute nodes
can be resolved.</p>
<p>Copy the Slurm AMIs to the region of the on-prem VPC.
Create an instance using the copied AMI.
Connect to the instance and confirm that the mount points mounted correctly.
You will probably have to change the DNS names for the file systems to IP addresses.
I created A records in the Route53 zone for the file systems so that if the IP addresses ever change in the future I can easily update them in one place without having to create a new AMI or updated any instances.
Create a new AMI from the instance.</p>
<p>Create compute node instances from the new AMI and run the following commands on them get the slurmd daemon running so
they can join the slurm cluster.</p>
<pre><code># Instance specific variables
hostname=onprem-c7-x86-t3-2xl-0

# Domain specific variables
onprem_domain=onprem.com

source /etc/profile.d/instance_vars.sh

# munge needs to be running before calling scontrol
/usr/bin/cp /opt/slurm/$ClusterName/config/munge.key /etc/munge/munge.key
systemctl enable munged
systemctl start munged

ipaddress=$(hostname -I)
$SLURM_ROOT/bin/scontrol update nodename=${hostname} nodeaddr=$ipaddress

# Set hostname
hostname_fqdn=${hostname}.${onprem_domain}
if [ $(hostname) != $hostname_fqdn ]; then
    hostnamectl --static set-hostname $hostname_fqdn
    hostnamectl --pretty set-hostname $hostname
fi

if [ -e /opt/slurm/${ClusterName}/config/users_groups.json ] &amp;&amp; [ -e /opt/slurm/${ClusterName}/bin/create_users_groups.py ]; then
    /opt/slurm/${ClusterName}/bin/create_users_groups.py -i /opt/slurm/${ClusterName}/config/users_groups.json
fi

# Create directory for slurmd.log
logs_dir=/opt/slurm/${ClusterName}/logs/nodes/${hostname}
if [[ ! -d $logs_dir ]]; then
    mkdir -p $logs_dir
fi
if [[ -e /var/log/slurm ]]; then
    rm -rf /var/log/slurm
fi
ln -s $logs_dir /var/log/slurm

systemctl enable slurmd
systemctl start slurmd
# Restart so that log file goes to file system
systemctl restart spot_monitor
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
